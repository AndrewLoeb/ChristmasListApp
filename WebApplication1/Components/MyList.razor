@using WebApplication1.Models
@using WebApplication1.Services
@using WebApplication1.Components
@using Microsoft.AspNetCore.Components.Web
@inject googleSheetsListService ListService
@inject userIdService UserIdService
@inject ProductMetadataService MetadataService

@using Blazored.Toast
@using Blazored.Toast.Services
@inject IToastService toastService

<h2>My List</h2>
<div class="table-responsive-md">
    <table class="table table-striped" aria-label="My wish list items">
        <thead>
            <tr>
                <th scope="col" width="150px">Actions</th>
                <th scope="col" width="100px"></th>
                <th scope="col" width="350px">Item</th>
                <th scope="col" width="350px">Notes</th>
                <th scope="col" width="200px">Link</th>
                <th scope="col" width="150px">Date Added</th>
            </tr>
        </thead>
        <tbody>
            @foreach (ItemModel item in myList)
    {
            @if (@item.ItemId == editItemId)
        {
            <tr>
                <td>
                    <div class="btn-group" role="group" aria-label="Edit item actions">
                        <button type="button" class="btn btn-success" @onclick="() => submitEditItem(item)" aria-label="Save changes">Save</button>
                        <button type="button" class="btn btn-secondary" @onclick="cancelEditItem" aria-label="Cancel editing">Cancel</button>
                    </div>
                </td>
                <td>
                    @if (!string.IsNullOrWhiteSpace(item.ImageUrl))
                    {
                        <img src="@item.ImageUrl" alt="@item.Item" style="max-width: 80px; max-height: 80px; object-fit: contain;" />
                    }
                </td>
                <td> <form> <input type="text" class="form-control" @bind="@item.Item" size="40px" maxlength="200" aria-label="Item name" /> </form> </td>
                <td> <form> <input type="text" class="form-control" @bind="@item.Notes" size="40px" maxlength="500" aria-label="Item notes" /> </form> </td>
                <td><form>  <input type="text" class="form-control" @bind="@item.Link" onclick="this.select();" size="20" maxlength="2000" aria-label="Item URL" /> </form></td>
                <td></td>
            </tr>
        }
        else
        {
        <tr>
            <td>
                <div class="btn-group" role="group" aria-label="@($"Actions for {item.Item}")">
                    <button type="button" class="btn btn-secondary" @onclick="() => editItem(item)" aria-label="@($"Edit {item.Item}")">Edit</button>
                    <button type="button" class="btn btn-secondary" @onclick="() => showDeleteConfirmation(item)" aria-label="@($"Delete {item.Item}")">Delete</button>
                </div>
            </td>
            <td>
                @if (!string.IsNullOrWhiteSpace(item.ImageUrl))
                {
                    <img src="@item.ImageUrl" alt="@item.Item" style="max-width: 80px; max-height: 80px; object-fit: contain;" />
                }
            </td>
            <td>@item.Item</td>
            <td style="word-wrap:break-word; max-width:350px"> @item.Notes </td>
            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">
                @if (!string.IsNullOrWhiteSpace(item.Link))
                {
                    <a href="@item.Link" target="_blank" title="@item.Link">@(item.Link.Length > 30 ? item.Link.Substring(0, 30) + "..." : item.Link)</a>
                }
            </td>
            <td>@FormatDateTime(item.DateUpdated)</td>
        </tr>
        }
    }
        </tbody>
    </table>
</div>
    <br />
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <h3 id="add-item-heading">Add Item</h3>
            <form aria-labelledby="add-item-heading">
                <div class="row g-3 mb-3">
                    <div class="col-12 col-md-6">
                        <label for="newItemName" class="form-label">Item Name</label>
                        <input id="newItemName" type="text" class="form-control" placeholder="New Item" @bind="newItemItem" onclick="this.select();" maxlength="200" aria-label="New item name" required />
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="newItemNotes" class="form-label">Notes (Optional)</label>
                        <input id="newItemNotes" type="text" class="form-control" placeholder="Notes (Optional)" @bind="newItemNotes" onclick="this.select();" maxlength="500" aria-label="Optional notes for item" />
                    </div>
                    <div class="col-12 col-md-8">
                        <label for="newItemLink" class="form-label">Link (Optional)</label>
                        <input id="newItemLink" type="text" class="form-control" placeholder="Link (Optional)" @bind="newItemLink" onclick="this.select();" maxlength="2000" aria-label="Optional URL link for item" />
                    </div>
                    <div class="col-12 col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-success w-100" @onclick="addItem" disabled="@isAddingItem">
                            @if (isAddingItem)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Adding...</span>
                            }
                        else
                        {
                            <span>Add</span>
                        }
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <hr />
    <h3 id="notes-heading">Notes to Share:</h3>
    @if (editNotesFlag == 0)
{
    <p aria-label="Your shared notes"> @myNotes </p>
    <button type="button" class="btn btn-secondary" @onclick="editNotes" aria-label="Edit your shared notes">Edit Notes</button>
}
else
{
    <textarea class="form-control" cols="40" rows="5" @bind="newNotes" maxlength="500" aria-label="Edit shared notes" aria-describedby="notes-heading"></textarea>
    <div class="mt-2">
        <button type="button" class="btn btn-success" @onclick="submitEditNotes" aria-label="Save notes changes">Save Notes</button>
        <button type="button" class="btn btn-secondary ml-2" @onclick="cancelEditNotes" aria-label="Cancel notes editing">Cancel</button>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-labelledby="deleteModalTitle" aria-modal="true" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalTitle">Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="cancelDelete" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong>@itemToDelete?.Item</strong>?</p>
                    <p class="text-muted">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="cancelDelete" aria-label="Cancel deletion">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="confirmDelete" aria-label="@($"Confirm delete {itemToDelete?.Item}")">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

    @code
{
        private List<ItemModel> _myList;
        private string _myNotes;

        public List<ItemModel> myList
        {
            get
            {
                if (_myList == null)
                {
                    try
                    {
                        _myList = ListService.GetMyList(UserIdService.userId);
                    }
                    catch (Exception ex)
                    {
                        toastService.ShowError($"Error loading your list: {ex.Message}");
                        _myList = new List<ItemModel>();
                    }
                }
                return _myList;
            }
        }

        public string myNotes
        {
            get
            {
                if (_myNotes == null)
                {
                    try
                    {
                        _myNotes = ListService.Users_GetList().FirstOrDefault(u => u.Name == UserIdService.userId)?.Notes ?? "";
                    }
                    catch (Exception ex)
                    {
                        toastService.ShowError($"Error loading notes: {ex.Message}");
                        _myNotes = "";
                    }
                }
                return _myNotes;
            }
        }

        public string newItemItem = "";
        public string newItemNotes = "";
        public string newItemLink = "";
        //public string newItemItem = "New Item";
        //public string newItemNotes = "Notes (Optional)";
        //public string newItemLink = "Link (Optional)";

        public int editItemId = 0;
        public int editNotesFlag = 0;
        public string newNotes = "";
        public bool showDeleteModal = false;
        public ItemModel itemToDelete = null;
        public bool isAddingItem = false;

        // Store original values for cancel functionality
        private string originalItemName = "";
        private string originalItemNotes = "";
        private string originalItemLink = "";

        // Validation constants
        private const int MAX_ITEM_NAME_LENGTH = 200;
        private const int MAX_NOTES_LENGTH = 500;
        private const int MAX_LINK_LENGTH = 2000;

        private bool ValidateUrl(string url)
        {
            if (string.IsNullOrWhiteSpace(url))
                return true; // URL is optional

            // Check length
            if (url.Length > MAX_LINK_LENGTH)
                return false;

            // Check if it's a valid URI
            return Uri.TryCreate(url, UriKind.Absolute, out Uri uriResult)
                && (uriResult.Scheme == Uri.UriSchemeHttp || uriResult.Scheme == Uri.UriSchemeHttps);
        }

        private bool ValidateItemName(string itemName)
        {
            if (string.IsNullOrWhiteSpace(itemName))
            {
                toastService.ShowError("Item name is required.");
                return false;
            }

            if (itemName.Length > MAX_ITEM_NAME_LENGTH)
            {
                toastService.ShowError($"Item name cannot exceed {MAX_ITEM_NAME_LENGTH} characters.");
                return false;
            }

            return true;
        }

        private bool ValidateNotes(string notes)
        {
            if (string.IsNullOrWhiteSpace(notes))
                return true; // Notes are optional

            if (notes.Length > MAX_NOTES_LENGTH)
            {
                toastService.ShowError($"Notes cannot exceed {MAX_NOTES_LENGTH} characters.");
                return false;
            }

            return true;
        }

        public void editNotes()
        {
            // Prevent editing if an item is being edited
            if (editItemId != 0)
            {
                toastService.ShowWarning("Please save or cancel the current item first.");
                return;
            }

            newNotes = myNotes;
            editNotesFlag = 1;
        }
        public void submitEditNotes()
        {
            // Validate notes length
            if (!ValidateNotes(newNotes))
                return;

            ListService.UpdateNotes(UserIdService.userId, newNotes);
            _myNotes = newNotes;
            editNotesFlag = 0;
            toastService.ShowSuccess("Saved Notes");
        }

        public void cancelEditNotes()
        {
            newNotes = "";
            editNotesFlag = 0;
        }
        public async Task addItem()
        {
            if (isAddingItem)
            {
                System.Console.WriteLine("addItem called while already adding - ignoring duplicate call");
                return;
            }

            isAddingItem = true;
            StateHasChanged();
            await Task.Delay(10); // Small delay to ensure UI updates

            try
            {
                System.Console.WriteLine($"Added: {newItemItem}");

                if (newItemNotes.Equals("Notes (Optional)")) { newItemNotes = ""; }
                if (newItemLink.Equals("Link (Optional)")) { newItemLink = ""; }

                // Validate inputs
                if (!ValidateItemName(newItemItem))
                    return;

                if (!ValidateNotes(newItemNotes))
                    return;

                if (!ValidateUrl(newItemLink))
                {
                    toastService.ShowError("Please enter a valid URL (must start with http:// or https://).");
                    return;
                }

                string imageUrl = "";
                decimal? price = null;
                string metadataFetchedDate = "";

                // If there's a link, try to fetch product metadata
                if (!string.IsNullOrWhiteSpace(newItemLink))
                {
                    try
                    {
                        toastService.ShowInfo("Fetching product details...");
                        var metadata = await MetadataService.FetchMetadataAsync(newItemLink);

                        if (metadata.Success)
                        {
                            imageUrl = metadata.ImageUrl ?? "";
                            price = metadata.Price;
                            metadataFetchedDate = DateTime.Now.ToString();

                            Console.WriteLine($"Fetched metadata - Image: {imageUrl}, Price: {price}");
                        }
                        else
                        {
                            Console.WriteLine($"Metadata fetch failed: {metadata.ErrorMessage}");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error fetching metadata: {ex.Message}");
                        // Continue anyway - we can save without metadata
                    }
                }

                ListService.AddItem(UserIdService.userId, newItemItem, newItemNotes, newItemLink, imageUrl, price, metadataFetchedDate);
                toastService.ShowSuccess("Added " + newItemItem + "!");

                //newItemItem = "New Item";
                //newItemNotes = "Notes (Optional)";
                //newItemLink = "Link (Optional)";
                newItemItem = "";
                newItemNotes = "";
                newItemLink = "";

                // Refresh the list
                _myList = null;
            }
            finally
            {
                isAddingItem = false;
                StateHasChanged();
            }
        }
        public void editItem(ItemModel item)
        {
            // Prevent editing if notes are being edited
            if (editNotesFlag == 1)
            {
                toastService.ShowWarning("Please save or cancel your notes edit first.");
                return;
            }

            // Prevent editing if another item is already being edited
            if (editItemId != 0)
            {
                toastService.ShowWarning("Please save or cancel the current item first.");
                return;
            }

            // Store original values for cancel functionality
            originalItemName = item.Item;
            originalItemNotes = item.Notes ?? "";
            originalItemLink = item.Link ?? "";

            editItemId = item.ItemId;
        }
        public void submitEditItem(ItemModel item)
        {
            // Validate inputs
            if (!ValidateItemName(item.Item))
                return;

            if (!ValidateNotes(item.Notes))
                return;

            if (!ValidateUrl(item.Link))
            {
                toastService.ShowError("Please enter a valid URL (must start with http:// or https://).");
                return;
            }

            ListService.UpdateItem(item.ItemId, item.Item, item.Notes, item.Link);
            editItemId = 0;
            toastService.ShowSuccess("Saved " + item.Item + "!");
            // Refresh the list
            _myList = null;
        }

        public void cancelEditItem()
        {
            // Restore original values
            var item = myList.FirstOrDefault(i => i.ItemId == editItemId);
            if (item != null)
            {
                item.Item = originalItemName;
                item.Notes = originalItemNotes;
                item.Link = originalItemLink;
            }

            editItemId = 0;
        }
        public void showDeleteConfirmation(ItemModel item)
        {
            itemToDelete = item;
            showDeleteModal = true;
        }

        public void cancelDelete()
        {
            showDeleteModal = false;
            itemToDelete = null;
        }

        public void confirmDelete()
        {
            if (itemToDelete != null)
            {
                ListService.DeleteItem(itemToDelete.ItemId);
                toastService.ShowSuccess("Deleted " + itemToDelete.Item + "!");
                showDeleteModal = false;
                itemToDelete = null;
                // Refresh the list
                _myList = null;
            }
        }

        private string FormatDateTime(string dateTimeStr)
        {
            if (string.IsNullOrWhiteSpace(dateTimeStr))
                return "";

            if (DateTime.TryParse(dateTimeStr, out DateTime dt))
            {
                return dt.ToString("MM/dd/yy h:mm tt");
            }

            return dateTimeStr; // Return original if parse fails
        }

    }
